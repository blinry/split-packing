%\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}

\usepackage{float}
%\usepackage{pgfplots}
%\usepackage{microtype}
\usepackage{xcolor}
    \definecolor{medium-blue}{rgb}{0,0,0.5}
\usepackage{algorithm}
\usepackage{algpseudocode}
    \renewcommand{\algorithmicrequire}{\textbf{Input:}}
    \renewcommand{\algorithmicensure}{\textbf{Output:}}
\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{mathtools}
    \mathtoolsset{centercolon}
\usepackage[nameinlink]{cleveref}
    \newtheorem{theorem}{Theorem}
    \newtheorem{corollary}{Corollary}
    \theoremstyle{definition}
    \newtheorem{definition}{Definition}
    \newtheorem{lemma}{Lemma}
    \newtheorem{problem}{Problem}
    \newtheorem{conjecture}{Conjecture}
\usepackage{amsfonts}
%\usepackage{todonotes}
\usepackage{tikz}
    \usetikzlibrary{calc}
    \usetikzlibrary{arrows}
    \usetikzlibrary{decorations.pathreplacing}
    %\usetikzlibrary{external}
    %\tikzexternalize[prefix=tikz/]
    \newcommand\fig[3][3]{%
        \begin{figure}%
            %\tikzsetnextfilename{#1}%
            \begin{tikzpicture}[scale=#1]%
                \input{tikz/#2.tex}%
            \end{tikzpicture}%
            \caption{#3}%
            \label{fig:#2}%
        \end{figure}%
    }
\usepackage{graphicx}
    \graphicspath{{images/}}
\usepackage{chngcntr}
    \counterwithout{equation}{chapter}
%\usepackage{nicefrac}
\usepackage{csquotes}
\usepackage{scrhack}
\usepackage[backend=biber,style=numeric-comp,maxbibnames=99,url=false]{biblatex}
    \addbibresource{../references/references.bib}

    %% Link complete "Author (Year)", not just "(Year)"
    %\DeclareFieldFormat{citehyperref}{%
    %  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
    %  \bibhyperref{#1}}

    %\DeclareFieldFormat{textcitehyperref}{%
    %  \DeclareFieldAlias{bibhyperref}{noformat}% Avoid nested links
    %  \bibhyperref{%
    %    #1%
    %    \ifbool{cbx:parens}
    %      {\bibcloseparen\global\boolfalse{cbx:parens}}
    %      {}}}

    %\savebibmacro{cite}
    %\savebibmacro{textcite}

    %\renewbibmacro*{cite}{%
    %  \printtext[citehyperref]{%
    %    \restorebibmacro{cite}%
    %    \usebibmacro{cite}}}

    %\renewbibmacro*{textcite}{%
    %  \ifboolexpr{
    %    ( not test {\iffieldundef{prenote}} and
    %      test {\ifnumequal{\value{citecount}}{1}} )
    %    or
    %    ( not test {\iffieldundef{postnote}} and
    %      test {\ifnumequal{\value{citecount}}{\value{citetotal}}} )
    %  }
    %    {\DeclareFieldAlias{textcitehyperref}{noformat}}
    %    {}%
    %  \printtext[textcitehyperref]{%
    %    \restorebibmacro{textcite}%
    %    \usebibmacro{textcite}}}

\newcommand{\C}{\mathbb{C}}
\newcommand{\s}{\sqrt{2}}
\newcommand{\wlofg}{without loss of generality}
\DeclareMathOperator{\mysum}{sum}
\DeclareMathOperator*{\argmin}{arg\,min}

\makeatletter
    % center the contents of floatstuff automatically
    \g@addto@macro\@floatboxreset\centering

    % set default placement for floatstuff
    \def\fps@figure{H}
    \def\fps@table{H}
    \def\fps@algorithm{H}
\makeatother

%%%%%%%%%%%% TikZ %%%%%%%%%%%%%%%

\newcommand{\B}{1.36207}

\tikzset{tight/.style={inner sep=1pt}}
\tikzset{bracket/.style={inner sep=10pt,draw=gray,decorate,decoration={brace,amplitude=5pt}}}
\tikzset{filled/.style={fill=black!30!white}}
\tikzset{filled2/.style={fill=black!15!white}}
\tikzset{cover/.style={fill=black!30!white,fill opacity=0.5,draw=none}}

%\newcommand\hatshape[3][]{
%    \pgfmathsetmacro{\r}{sqrt((#2)/pi)}
%    \pgfmathsetmacro{\s}{sqrt((#3)/pi)}
%
%    \coordinate (top) at (0,{(\r/(sqrt(2)-1)});
%    \coordinate (right) at ({(\r/(sqrt(2)-1)},0);
%    \coordinate (left) at ({(-\r/(sqrt(2)-1)},0);
%
%    \coordinate (leftcenter) at ($({-(\r-\s)/(sqrt(2)-1)},0)+(0,\s)$);
%    \coordinate (leftbottom) at ($(leftcenter)+(-90:\s)$);
%    \coordinate (lefttop) at ($(leftcenter)+(-225:\s)$);
%
%    \coordinate (rightcenter) at ($({(\r-\s)/(sqrt(2)-1)},0)+(0,\s)$);
%    \coordinate (rightbottom) at ($(rightcenter)+(-90:\s)$);
%    \coordinate (righttop) at ($(rightcenter)+(45:\s)$);
%
%    \coordinate (midcenter) at (0,\r);
%
%    \draw[#1] (rightbottom) arc (-90:45:\s) -- (top) -- (lefttop) arc (-225:-90:\s) -- cycle;
%}

\newcommand\hatshape[5][]{
    \pgfmathsetmacro{\r}{sqrt((#2)/pi)}
    \pgfmathsetmacro{\s}{sqrt((#3)/pi)}
    \pgfmathsetmacro{\a}{(#4)}
    \pgfmathsetmacro{\b}{(#5)}

    \coordinate (top) at ({cos((90+(\a-\b)/2))*(\r/cos((\a+\b)/2))},{sin((90+(\a-\b)/2))*(\r/cos((\a+\b)/2)});
    \coordinate (left) at ({-\r/tan(\a/2)},-\r);
    \coordinate (right) at ({\r/tan(\b/2)},-\r);

    \coordinate (leftcenter) at ($(left)+({\s/tan(\a/2)},\s)$);
    \coordinate (leftbottom) at ($(leftcenter)+(-90:\s)$);
    \coordinate (lefttop) at ($(leftcenter)+({-270+\a}:\s)$);

    \coordinate (rightcenter) at ($(right)+({-\s/tan(\b/2)},\s)$);
    \coordinate (rightbottom) at ($(rightcenter)+(-90:\s)$);
    \coordinate (righttop) at ($(rightcenter)+({90-\b}:\s)$);

    \coordinate (topcenter) at ($(top)-({cos((90+(\a-\b)/2))*(\s/cos((\a+\b)/2))},{sin((90+(\a-\b)/2))*(\s/cos((\a+\b)/2)})$);
    \coordinate (topleft) at ($(topcenter)+({-270+\a}:\s)$);
    \coordinate (topright) at ($(topcenter)+({90-\b}:\s)$);

    \coordinate (midcenter) at (0,0);

    %\draw[#1] (right) -- (top) -- (left) -- cycle;
    \draw[#1] (rightbottom) arc (-90:{90-\b}:\s) -- (topright) arc ({90-\b}:{90+\a}:\s) -- (lefttop) arc ({-270+\a}:-90:\s) -- cycle;
}
\newcommand\gemshape[3][]{
    \pgfmathsetmacro{\r}{sqrt((#2)/pi)}
    \pgfmathsetmacro{\s}{sqrt((#3)/pi)}
    \pgfmathsetmacro{\l}{0.85955*sqrt(#3)}
    \pgfmathsetmacro{\ll}{0.7654*\l}
    \pgfmathsetmacro{\a}{45}
    \pgfmathsetmacro{\b}{45}

    \coordinate (top) at ({cos((90+(\a-\b)/2))*(\r/cos((\a+\b)/2))},{sin((90+(\a-\b)/2))*(\r/cos((\a+\b)/2)});
    \coordinate (left) at ({-\r/tan(\a/2)},-\r);
    \coordinate (right) at ({\r/tan(\b/2)},-\r);

    \coordinate (leftcenter) at ($(left)+({\s/tan(\a/2)},\s)$);
    \coordinate (lefttop) at ($(left)+(45:\l)$);
    \coordinate (leftmid) at ($(left)+(22.5:\ll)$);
    \coordinate (leftbottom) at ($(left)+(0:\l)$);

    \coordinate (rightcenter) at ($(right)+({-\s/tan(\b/2)},\s)$);
    \coordinate (righttop) at ($(right)+(135:\l)$);
    \coordinate (rightmid) at ($(right)+(157.5:\ll)$);
    \coordinate (rightbottom) at ($(right)+(180:\l)$);

    %\coordinate (topcenter) at ($(top)-({cos((90+(\a-\b)/2))*(\s/cos((\a+\b)/2))},{sin((90+(\a-\b)/2))*(\s/cos((\a+\b)/2)})$);
    %\coordinate (topleft) at ($(topcenter)+({-270+\a}:\s)$);
    %\coordinate (topright) at ($(topcenter)+({90-\b}:\s)$);

    \coordinate (midcenter) at (0,0);

    \draw[#1] (top) -- (righttop) -- (rightmid) -- (rightbottom) -- (leftbottom) -- (leftmid) -- (lefttop) -- cycle;
    %\draw[#1] (rightbottom) arc (-90:{90-\b}:\s) -- (top) arc ({-270+\a}:-90:\s) -- cycle;
}

\newcommand\hatsinsquare[1]{
    \draw (0,0) rectangle (\B,\B);

    \pgfmathparse{\B-sqrt((1-(#1))/pi)}
    \begin{scope}[shift={(\pgfmathresult,\pgfmathresult)}]
        \begin{scope}[rotate=-45]
            \pgfmathsetmacro{\hata}{1-(#1)}
            \pgfmathsetmacro{\hatb}{1-2*(#1)}
            \hatshape[filled2]{\hata}{\hatb}{45}{45}
            \node at (midcenter) {\hata};
        \end{scope}
    \end{scope}

    \def\comparg{#1}
    \if\comparg0\else
        \pgfmathparse{(sqrt((#1)/pi)}
        \begin{scope}[shift={(\pgfmathresult,\pgfmathresult)}]
            \begin{scope}[rotate=-225]
                \hatshape[filled2]{#1}{0}{45}{45}
                \node at (midcenter) {#1};
            \end{scope}
        \end{scope}
    \fi
}

\newcommand\hatsinrect[1]{
    \draw (0,0) rectangle (1.5607,1);

    \pgfmathsetmacro{\hatx}{1-(#1)}
    \pgfmathsetmacro{\hata}{(1-(#1))*0.7853}
    \pgfmathsetmacro{\hatb}{(1-2*(#1))*0.7853}

    \pgfmathparse{sqrt(\hata/pi)}
    \begin{scope}[shift={(1.5607-\pgfmathresult,1-\pgfmathresult)}]
        \begin{scope}[rotate=-32.65]
            \hatshape[filled2]{\hata}{\hatb}{32.65}{57.35}
            \node at (midcenter) {\hatx};
        \end{scope}
    \end{scope}

    \def\comparg{#1}
    \if\comparg0\else
        \pgfmathparse{(sqrt((#1)*0.7853/pi)}
        \begin{scope}[shift={(\pgfmathresult,\pgfmathresult)}]
            \begin{scope}[rotate=-212.65]
                \hatshape[filled2]{#1*0.7853}{0}{32.65}{57.35}
                \node at (midcenter) {#1};
            \end{scope}
        \end{scope}
    \fi
}

\newcommand\gemsinsquare[1]{
    \draw (0,0) rectangle (\B,\B);

    \pgfmathparse{\B-sqrt((1-(#1))/pi)}
    \begin{scope}[shift={(\pgfmathresult,\pgfmathresult)}]
        \begin{scope}[rotate=-45]
            \pgfmathsetmacro{\hata}{1-(#1)}
            \pgfmathsetmacro{\hatb}{1-2*(#1)}
            \gemshape[filled2]{\hata}{\hatb}
            \node at (midcenter) {\hata};
        \end{scope}
    \end{scope}

    \def\comparg{#1}
    \if\comparg0\else
        \pgfmathparse{(sqrt((#1)/pi)}
        \begin{scope}[shift={(\pgfmathresult,\pgfmathresult)}]
            \begin{scope}[rotate=-225]
                \gemshape[filled2]{#1}{0}
                \node at (midcenter) {#1};
            \end{scope}
        \end{scope}
    \fi
}

% a, alpha, beta, incircle-area of right hat, rounding
\newcommand\hatsinhat[5][1]{
    \pgfmathsetmacro{\area}{(#1)}
    \pgfmathsetmacro{\a}{(#2)}
    \pgfmathsetmacro{\b}{(#3)}
    \pgfmathsetmacro{\x}{(#4)}
    \pgfmathsetmacro{\round}{(#5)}
    \pgfmathsetmacro{\f}{(cos(\b/2)^2*sec(\a/2+\b/2)^2*(1-sin(\a)))}
    \pgfmathsetmacro{\g}{(cos(\a/2)^2*sec(\a/2+\b/2)^2*(1-sin(\b)))}

    \hatshape{\area}{\round}{\a}{\b}

    \def\comparg{\x}
    \if\comparg0\else
        \pgfmathparse{sqrt(\area/pi)/tan(\b/2)-sqrt(((\x))/pi)/tan(\b/2)}
        \begin{scope}[shift={(\pgfmathresult,0)}]
            \pgfmathparse{sqrt(\area/pi)-sqrt(\x/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)}]
                \pgfmathsetmacro{\hata}{\x}
                \pgfmathsetmacro{\hatb}{max(\round,\x-\g*(1-\x)/(\f)))}
                \hatshape[filled2]{\hata}{\hatb}{90}{\b}
                \node at (midcenter) {$\hata a$};
            \end{scope}
        \end{scope}
    \fi

    \def\comparg{\x}
    \if\comparg1\else
        \pgfmathparse{sqrt(\area/pi)/tan(\a/2)-sqrt(((1-\x))/pi)/tan(\a/2)}
        \begin{scope}[shift={(-\pgfmathresult,0)}]
            \pgfmathparse{sqrt(\area/pi)-sqrt((1-\x)/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)}]
                \pgfmathsetmacro{\hata}{1-\x}
                \pgfmathsetmacro{\hatb}{\round}
                \pgfmathsetmacro{\hatb}{max(\round,(1-\x)-\f*(\x)/(\g)))}
                \hatshape[filled2]{\hata}{\hatb}{\a}{90}
                \node at (midcenter) {$\hata a$};
            \end{scope}
        \end{scope}
    \fi
}

% incircle-area of right hat, rounding
\newcommand\gemsingem[2]{
    \pgfmathsetmacro{\a}{45}
    \pgfmathsetmacro{\b}{45}
    \pgfmathsetmacro{\x}{(#1)}
    \pgfmathsetmacro{\round}{(#2)}
    \pgfmathsetmacro{\f}{(cos(\b/2)^2*sec(\a/2+\b/2)^2*(1-sin(\a)))}
    \pgfmathsetmacro{\g}{(cos(\a/2)^2*sec(\a/2+\b/2)^2*(1-sin(\b)))}

    \gemshape{1}{\round}

    \def\comparg{\x}
    \if\comparg0\else
        \pgfmathparse{sqrt(1/pi)/tan(\b/2)-sqrt(((\x))/pi)/tan(\b/2)}
        \begin{scope}[shift={(\pgfmathresult,0)}]
            \pgfmathparse{sqrt(1/pi)-sqrt(\x/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)},rotate=135]
                \pgfmathsetmacro{\hata}{\x}
                \pgfmathsetmacro{\hatb}{max(\round,\x-\g*(1-\x)/(\f)))}
                \gemshape[filled2]{\hata}{\hatb}
                \node at (midcenter) {$\hata$};
            \end{scope}
        \end{scope}
    \fi

    \def\comparg{\x}
    \if\comparg1\else
        \pgfmathparse{sqrt(1/pi)/tan(\a/2)-sqrt(((1-\x))/pi)/tan(\a/2)}
        \begin{scope}[shift={(-\pgfmathresult,0)}]
            \pgfmathparse{sqrt(1/pi)-sqrt((1-\x)/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)}]
                \pgfmathparse{\x < 0.1715 ? 0 : -135}
                \begin{scope}[rotate=\pgfmathresult]
                    \pgfmathsetmacro{\hata}{1-\x}
                    \pgfmathsetmacro{\hatb}{\round}
                    \pgfmathsetmacro{\hatb}{\x < 1/3 ? (1-\x) : max(\round,(1-\x)-\f*(\x)/(\g))}
                    \pgfmathsetmacro{\fillstyle}{\x < 1/3 ? "filled" : "filled2"}
                    \gemshape[\fillstyle]{\hata}{\hatb}
                    \node at (midcenter) {$\hata$};
                \end{scope}
            \end{scope}
        \end{scope}
    \fi
}

