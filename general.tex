\chapter{Split Packing}

\section{Greedy splitting}

The core idea of the proposed packing algorithms is to recursively split the set of input circles into groups. The method which performs this splitting resembles a greedy scheduling algorithm. It is going to be important for the packing algorithm that the ratios of the groups' sums is close to certain factors.

The algorithm, \textsc{Split}, takes two parameters: The first is an arbitrary circle instance $C$. The second is a tuple of two positive factors, which determines which percentages of $C$'s sum should go into the respective groups. For example, if we wanted to split $C$ into equally sized halves, we could choose the tuple $(1,1)$, and if we wanted to split $C$ in two groups with a ratio of 1:3, we we could use $(1,3)$. We call this tuple the \emph{split key}:

\begin{definition}
    A \emph{split key} is a tuple of two positive real numbers.
\end{definition}

In each step, \textsc{Split} adds the largest remaining circle of the input instance to the “emptiest” group---the group where the ratio between the current sum and the associated factor of the split key is the smallest. The scenario which is easiest to imagine is when the split key actually describes the desired total area of that group, and \textsc{Split} puts the next circle into the group which has the smallest “filling level”.

\begin{algorithm}[htbp!]
    \caption{\textsc{Split}$(C,F)$}
    \begin{algorithmic}
        \Require A circle instance $C$ and a split key $F = (f_1, f_2)$
        \Ensure Circle instances $C_1, C_2$
        \State $C_1 \gets \emptyset$
        \State $C_2 \gets \emptyset$
        \State Sort $C$ descending by size
        \ForAll{$c \in C$}
            \State $j = \argmin_{i} \frac{\mysum(C_i)}{f_i}$\Comment{Find the index of the emptiest instance}
            \State $C_j \gets C_j \cup \{c\}$
        \EndFor
    \end{algorithmic}
\end{algorithm}

Of course, it will not always be possible to achieve these desired ratios exactly (for example if the input instance consists of few very large elements which cannot be distributed in the specified ratios), but we can derive an interesting property from the resulting subinstances if the resulting group's sizes derive from the split key:

\begin{lemma}\label{th:split-property}
    For any circle instance $C$ and any split key $F = (f_1, f_2)$, \textsc{Split}$(C,F)$ decomposes $C$ into two circle instances $C_1$ and $C_2$. Set $a_i \coloneqq \mysum(C_i)$ and wlog assume $\frac{a_2}{f_2} \le \frac{a_1}{f_1}$.
    Then $\min(C_1) \ge a_1 - f_1\frac{a_2}{f_2}$.
\end{lemma}

\begin{proof}
    For the minimum size, assume for contradicion that $C_i$ contained an element smaller than $a_i - f_i r$. All elements which were put into $C_i$ after that have to be at least as small, as the elements were inserted by descending size. So the last element put into $C_i$ (let us call it $c$) would be smaller than $a_i - f_i r$, as well.
    But this means that $\frac{a_i - c}{f_i} > \frac{a_i - (a_i - f_i r)}{f_i} = r$, meaning that at the moment before $c$ was inserted, the relative filling level of $C_i$ would already have been larger than $r$. But $r$ is the smallest relative filling level by the time the algorithm ends, so at the time when $c$ is inserted, the group's filling level would have been at least as small.
    This is a contradiction to the algorithm's greedy nature, as \textsc{Split} would not have but $c$ into the (fuller) group $C_i$ in this situation.
\end{proof}

\begin{lemma}
    For any circle instance $C$ and any split key $F = (f_1, f_2)$, if \textsc{Split}$(C,F)$ produces two circle instances $C_1$ and $C_2$ with $\mysum(C_1) > 2 f_1 \frac{\mysum(C_2)}{f_2}$, then $|C_1| = 1$.
\end{lemma}

\begin{proof}
    The condition is equivalent to $\mysum(C_1) - f_1 \frac{\mysum(C_2)}{f_2} > \frac{\mysum(C_1)}{2}$, or $\min(C_1) > \frac{\mysum(C_1)}{2}$, which means that the minimum size of the circles in $C_1$ is more than half of its total sum. The only possible instance which satisfies this constraint is a single circle with area $\mysum(C_1$).
\end{proof}

%Here is a definition that makes it easier to talk about 
%The next definition looks a bit weird, but makes it easier to talk about multiple shapes:
To make it easier to talk about the properties of the groups output by \textsc{Split}, we introduce the notion of \emph{$(F,b)$-roundedness}:

%\begin{definition}\label{def:rounded}
%    For any split key $F$ of length $n$, we say that a tuple of $n$ shapes is \emph{$(F,b)$-rounded}, if the $i$-th shape is a $\C(a_i, \min\{b,a_i - f_i r\})$-shape, with $r = \max\{\frac{a_i}{f_i}|i \in 1,2,\dots,n\}$.
%\end{definition}

\begin{definition}\label{def:rounded}
    For any split key $F = (f_1, f_2)$ and any $b \ge 0$ we say that $n$ tuples $(a_1, b_1)$, $(a_2, b_2)$ are \emph{$(F,b)$-rounded} if each $b_i = \max\{b,a_i - f_i \min\{\frac{a_1}{f_1}, \frac{a_2}{f_2}\}\}$.
\end{definition}

We can now associate this property with \textsc{Split} in the following theorem:

\begin{theorem}\label{th:split-sets}
    For any $C \in \C(a,b)$, and any split key $F = (f_1, f_2)$, \textsc{Split}$(C,F)$ produces $n$ subinstances $C_1 \in \C(a_1, b_1), C_2 \in \C(a_2, b_2)$, so that $C_1 + C_2 + C_n = C$ and the instance sets' parameters are $(F,b)$-rounded.
\end{theorem}

\begin{proof}
    That the subinstances add up to the original instance is obvious from the algorithm.
    For the roundedness, as $\min(C) \ge b$, the subinstances must have the same property. Additionally, by \Cref{th:split-property}, $C_i \in \C(a_i, a_i - f_i \min\{\frac{a_1}{f_1}, \frac{a_2}{f_2}\})$. Thus, the subinstances satisfy \Cref{def:rounded}.
\end{proof}

%What is means for shapes to be $(F,b)$-rounded is that we lift some requirements on which instances they need to be able to pack. We combine two lower bounds for the minimum size of the instances: First, the shapes never need to be able to pack any instances containing circles smaller than $b$. Second, they reflect the \textsc{Split}-algorithm's minimum element sizes stated in \Cref{th:split-property}. If a subinstance $C_i$ returned by \textsc{Split} can not possibly contain any circles smaller than a certain size, it makes sense to also relax the requirements for the shapes in which these subinstances will be packed: It suffices if they can pack those instances where the circles have this minimum size. Whichever of the two circle sizes requirements is largest, determines the “minimum size” of the rounded shape.

%Put differently, to have $F$-rounded shapes of the correct totals is a sufficient condition to be able to pack resulting subinstances of a \textsc{Split} operation into them. This is expressed in the following lemma:

\section{Shapes, Rounding, and Split Packing}

%We will now make some general observations about shapes which are suitable to pack certain classes of circle instances. Most of the proofs appearing in later chapters, while tailored to specific kinds of shapes (triangles, squares), will use these quite universal theorems.
We will now turn to general shapes. It is often interesting to state that a shape can pack certain classes of circle instances. For this, we define the term \emph{$\mathcal{C}$-shape}:

\begin{definition}
    For any $\mathcal{C} \subseteq \C$, a $\mathcal{C}$-shape is a shape in which each $C \in \mathcal{C}$ can be packed.
\end{definition}

For example, if a shape is a $\C(a)$-shape, it means that each circle instance with a sum of $a$ can be packed into the shape. That's an interesting property that we will hunt after for most of this thesis, as it means no matter how the instances divide the area $a$ into circles, they can all be packed into the shape.

For convenience, we define the \emph{sum} of a $\C(a)$-shape:

\begin{definition}
    For a $\C(a)$-shape, we call $a$ the shape's \emph{sum}.
\end{definition}

We also extend our roundedness definition to shapes:

\begin{definition}
    We say that $n$ shapes are $(F,b)$-rounded if they are a $\C(a_1, b_1)$-shape and a $\C(a_2, b_2)$-shape and their parameter tuples are $(F,b)$-rounded.
\end{definition}

%Recall that $\C(a,b)$ contains all circle instances with a sum of $a$ and a minimum circle size of $b$. If a shape is a $\C(a,b)$-shape with $b > 0$, it means that it can pack all circle instances $C$ with $\mysum(C) \le a$ and $\min(C) \ge b$. This leads to an interesting effect: As the shape does not need to accomodate for circles smaller than $b$, it can be “rounded” to a radius of a $b$-circle. Sharper corners will be superfluous, as circles in $\C(a,b$) will not be permitted to be placed there anyway.
%In particular, this means that the shape's maximum local curvature can be the curvature of a $b$-circle, as when the curvature is 


%\begin{theorem}
%    A shape is a $\mathcal{C}$-shape, if, for a given decomposition method, for all possible decompositions $C_1, C_2, \dots, C_n$ of any $C \in \mathcal{C}$, one can always find $n$ shapes in which the resulting subinstances can be packed, and which fit into the original shape.
%\end{theorem}

%\begin{theorem}
%    A shape is a $\C(a,b)$-shape, if there is a split key $F$, so that for all $a_1 + a_2 + \dots + a_n \le a$, one can find a $\C(a_1)$-shape, a $\C(a_2)$-shape, \dots, and a $\C(a_n)$-shape, which are $F$-rounded and fit into the original shape.
%\end{theorem}

%\begin{lemma}\label{th:split-rounded}
%    Given an arbitrary $C \in \C(a,b)$ and a split key $F$, use \textsc{Split}$(C,F)$ to decompose $C$ into $n$ subinstances. Call the subinstances' totals $a_1$, $a_2$, \dots, $a_n$. If we can find a $\C(a_1, b_1)$-shape, a $\C(a_2, b_2)$-shape, \dots, and a $\C(a_n, b_n)$-shape, so that the shapes' parameters are $(F,b)$-rounded, we can pack $C$ into the shapes.
%\end{lemma}
%
%\begin{proof}
%    We know from \Cref{th:split-sets} that \textsc{Split} only produces subinstances $C_i \in \C(a_i, b_i)$ so that the instance set's parameters are $(F,b)$-rounded. As the $i$-th shape is a $\C(a_i, b_i)$ shape, we can pack $C_i$ into it.
%\end{proof}

With these preparations, we can now state our central \emph{split packing} theorem:

\begin{theorem}[Split Packing]\label{th:splitpack}
    For a given shape $s$, and for any $0 \le b < a$, if there is a split key $F$ of length $n$, so that for all tuples $(a_1, a_2)$ with $a_1 + a_2 \le a$
    one can find $n$ $(F,b)$-rounded shapes of matching sums,
    and these shapes can be packed into $s$, then $s$ is a $\C(a,b)$-shape.
\end{theorem}

\begin{proof}
    Consider an arbitrary $C \in \C(a,b)$. Regardless of which groups \textsc{Split} produces, we know from \Cref{th:split-sets} that they always are elements of $(F,b)$-rounded circle instance sets.
    As we can find $(F,b)$-rounded shapes with matching sums, the $i$-th group can be packed into the $i$-th shape.
    As these shapes also fit into $s$, we know that we can pack $C$ into $s$.
\end{proof}

As this theorem is important for the whole thesis, let us rephrase it: \Cref{th:splitpack} describes what is sufficient to proof that a shape is a $\C(a,b)$-shape: Find a shape-specific split key $F$ and show that for all possible decompositions of the area $a$ (which is going to be perfomed by \textsc{Split}), that one can find $(F,b)$-rounded shapes of matching sums that fit into the original shape.

The general \textsc{Splitpack} algorithm, then, reads as follows:

\begin{algorithm}[htbp!]
    \caption{\textsc{Splitpack}$(s,C)$}
    \begin{algorithmic}
        \Require A $\C(a,b)$-shape $s$ and a circle instance $C \in \C(a,b)$
        \Ensure A packing of $C$ into $s$
        \State Determine split key $F$ for $s$
        \State $(C_1, C_2) \gets \textsc{Split}(C,F)$
        \State $(s_1, s_2) \gets$ any $(F,b)$-rounded shapes with $\mysum(s_i) = \mysum(C_i)$
        \State Pack these shapes into $s$
        \ForAll{$C_i \in (C_1, C_2)$}
            \State \Call{Splitpack}{$s_i, C_i$}
        \EndFor
    \end{algorithmic}
\end{algorithm}

%One needs the following elements to use \textsc{Splitpack} for a shape:
%
%\begin{enumerate}
%    \item A strategy to determine the split factor $F$
%    \item A strategy to determine $n$ $(F,b)$-rounded shapes of matching sums for each decomposition of the area $a$
%    \item A strategy to pack these shapes into $s$
%\end{enumerate}
%
%To proof that the shape is indeed a $\C(a,b)$-shape, one needs to show that these three strategies always work.

%\section{Normalization}

%In some proofs, we will normalize the instances, shapes, or figures in question. For example, we can scale all areas involved up by a factor of $f$, as long as we scale all lengths up by a factor of $\sqrt{f}$.
