\newcommand{\B}{1.36207}

\tikzset{tight/.style={inner sep=1pt}}
\tikzset{bracket/.style={inner sep=10pt,draw=gray,decorate,decoration={brace,amplitude=5pt}}}
\tikzset{filled/.style={fill=black!30!white}}
\tikzset{filled2/.style={fill=black!15!white}}

%\newcommand\hatshape[3][]{
%    \pgfmathsetmacro{\r}{sqrt((#2)/pi)}
%    \pgfmathsetmacro{\s}{sqrt((#3)/pi)}
%
%    \coordinate (top) at (0,{(\r/(sqrt(2)-1)});
%    \coordinate (right) at ({(\r/(sqrt(2)-1)},0);
%    \coordinate (left) at ({(-\r/(sqrt(2)-1)},0);
%
%    \coordinate (leftcenter) at ($({-(\r-\s)/(sqrt(2)-1)},0)+(0,\s)$);
%    \coordinate (leftbottom) at ($(leftcenter)+(-90:\s)$);
%    \coordinate (lefttop) at ($(leftcenter)+(-225:\s)$);
%
%    \coordinate (rightcenter) at ($({(\r-\s)/(sqrt(2)-1)},0)+(0,\s)$);
%    \coordinate (rightbottom) at ($(rightcenter)+(-90:\s)$);
%    \coordinate (righttop) at ($(rightcenter)+(45:\s)$);
%
%    \coordinate (midcenter) at (0,\r);
%
%    \draw[#1] (rightbottom) arc (-90:45:\s) -- (top) -- (lefttop) arc (-225:-90:\s) -- cycle;
%}

\newcommand\hatshape[5][]{
    \pgfmathsetmacro{\r}{sqrt((#2)/pi)}
    \pgfmathsetmacro{\s}{sqrt((#3)/pi)}
    \pgfmathsetmacro{\a}{(#4)}
    \pgfmathsetmacro{\b}{(#5)}

    \coordinate (top) at ({cos((90+(\a-\b)/2))*(\r/cos((\a+\b)/2))},{sin((90+(\a-\b)/2))*(\r/cos((\a+\b)/2)});
    \coordinate (left) at ({-\r/tan(\a/2)},-\r);
    \coordinate (right) at ({\r/tan(\b/2)},-\r);

    \coordinate (leftcenter) at ($(left)+({\s/tan(\a/2)},\s)$);
    \coordinate (leftbottom) at ($(leftcenter)+(-90:\s)$);
    \coordinate (lefttop) at ($(leftcenter)+({-270+\a}:\s)$);

    \coordinate (rightcenter) at ($(right)+({-\s/tan(\b/2)},\s)$);
    \coordinate (rightbottom) at ($(rightcenter)+(-90:\s)$);
    \coordinate (righttop) at ($(rightcenter)+({90-\b}:\s)$);

    \coordinate (topcenter) at ($(top)-({cos((90+(\a-\b)/2))*(\s/cos((\a+\b)/2))},{sin((90+(\a-\b)/2))*(\s/cos((\a+\b)/2)})$);
    \coordinate (topleft) at ($(topcenter)+({-270+\a}:\s)$);
    \coordinate (topright) at ($(topcenter)+({90-\b}:\s)$);

    \coordinate (midcenter) at (0,0);

    %\draw[#1] (right) -- (top) -- (left) -- cycle;
    \draw[#1] (rightbottom) arc (-90:{90-\b}:\s) -- (topright) arc ({90-\b}:{90+\a}:\s) -- (lefttop) arc ({-270+\a}:-90:\s) -- cycle;
}

\newcommand\hatsinsquare[1]{
    \draw (0,0) rectangle (\B,\B);

    \pgfmathparse{\B-(sqrt((1-(#1))/pi)/(sqrt(2)-1))/sqrt(2)}
    \begin{scope}[shift={(\pgfmathresult,\pgfmathresult)}]
        \begin{scope}[rotate=-45]
            \pgfmathsetmacro{\hata}{1-(#1)}
            \pgfmathsetmacro{\hatb}{1-2*(#1)}
            \hatshape[filled]{\hata}{\hatb}
            \node at (midcenter) {\hata};
        \end{scope}
    \end{scope}

    \def\comparg{#1}
    \if\comparg0\else
        \pgfmathparse{(sqrt((#1)/pi)/(sqrt(2)-1))/sqrt(2)}
        \begin{scope}[shift={(\pgfmathresult,\pgfmathresult)}]
            \begin{scope}[rotate=-225]
                \hatshape[filled2]{#1}{0}
                \node at (midcenter) {#1};
            \end{scope}
        \end{scope}
    \fi
}

% alpha, beta, incircle-area of right hat, rounding
\newcommand\hatsinhat[4]{
    \pgfmathsetmacro{\a}{(#1)}
    \pgfmathsetmacro{\b}{(#2)}
    \pgfmathsetmacro{\x}{(#3)}
    \pgfmathsetmacro{\round}{(#4)}
    \pgfmathsetmacro{\f}{(1/(1+(1+cot(45-\b/2))^2/(1+cot(45-\a/2))^2))}

    \hatshape{1}{\round}{\a}{\b}

    \def\comparg{\x}
    \if\comparg0\else
        \pgfmathparse{sqrt(1/pi)/tan(\b/2)-sqrt(((\x))/pi)/tan(\b/2)}
        \begin{scope}[shift={(\pgfmathresult,0)}]
            \pgfmathparse{sqrt(1/pi)-sqrt(\x/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)}]
                \pgfmathsetmacro{\hata}{\x}
                \pgfmathsetmacro{\hatb}{max(\round,\f*(\x/\f-(1-\x)/(1-\f)))}
                \hatshape[filled]{\hata}{\hatb}{90}{\b}
                \node at (midcenter) {\hata};
            \end{scope}
        \end{scope}
    \fi

    \def\comparg{\x}
    \if\comparg1\else
        \pgfmathparse{sqrt(1/pi)/tan(\a/2)-sqrt(((1-\x))/pi)/tan(\a/2)}
        \begin{scope}[shift={(-\pgfmathresult,0)}]
            \pgfmathparse{sqrt(1/pi)-sqrt((1-\x)/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)}]
                \pgfmathsetmacro{\hata}{1-\x}
                \pgfmathsetmacro{\hatb}{\round}
                \pgfmathsetmacro{\hatb}{max(\round,(1-\f)*((1-\x)/(1-\f)-(\x)/(\f)))}
                \hatshape[filled2]{\hata}{\hatb}{\a}{90}
                \node at (midcenter) {\hata};
            \end{scope}
        \end{scope}
    \fi
}

% alpha, beta
\newcommand\hatf[2]{
    \pgfmathsetmacro{\a}{(#1)}
    \pgfmathsetmacro{\b}{(#2)}
    \pgfmathsetmacro{\round}{0.1}
    \pgfmathsetmacro{\f}{(1/(1+(1+cot(45-\b/2))^2/(1+cot(45-\a/2))^2))}

    \hatshape{1}{\round}{\a}{\b}
    %\hatshape[dashed]{1}{0}{\a}{\b}

    \pgfmathparse{sqrt(1/pi)/tan(\b/2)-sqrt(((\f))/pi)/tan(\b/2)}
    \begin{scope}[shift={(\pgfmathresult,0)}]
        \pgfmathparse{sqrt(1/pi)-sqrt(\f/pi)}
        \begin{scope}[shift={(0,-\pgfmathresult)}]
            \pgfmathsetmacro{\hata}{\f}
            \hatshape[dashed]{\hata}{0}{90}{\b}
            \pgfmathsetmacro{\r}{sqrt(\f/pi)}
            \draw (midcenter) circle(\r) node {$f_2$};
        \end{scope}
    \end{scope}

    \def\comparg{\f}
    \if\comparg1\else
        \pgfmathparse{sqrt(1/pi)/tan(\a/2)-sqrt(((1-\f))/pi)/tan(\a/2)}
        \begin{scope}[shift={(-\pgfmathresult,0)}]
            \pgfmathparse{sqrt(1/pi)-sqrt((1-\f)/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)}]
                \pgfmathsetmacro{\hata}{1-\f}
                \hatshape[dashed]{\hata}{0}{\a}{90}
                \pgfmathsetmacro{\r}{sqrt((1-\f)/pi)}
                \draw (midcenter) circle(\r) node {$f_1$};
            \end{scope}
        \end{scope}
    \fi
}

\newcommand\hatlr[4]{
    \pgfmathsetmacro{\a}{(#1)}
    \pgfmathsetmacro{\b}{(#2)}
    \pgfmathsetmacro{\aa}{(#3)}
    \pgfmathsetmacro{\bb}{(#4)}

    \hatshape{1}{0}{\a}{\b}
    \draw (midcenter) circle(\r);
    \draw[draw=none] (left) -- node[sloped,above] {$x$} (top);
    \draw[draw=none] (top) -- node[sloped,above] {$y$} (right);

    \coordinate (lc) at ($(midcenter)-(\r,0)$);
    \coordinate (rc) at ($(midcenter)+(\r,0)$);
    \coordinate (l) at ($(midcenter)+(-\r,-\r)$);
    \coordinate (r) at ($(midcenter)+(\r,-\r)$);

    \draw[dashed] (lc) -- (l);
    \draw[dashed] (rc) -- (r);

    \draw[bracket] ([yshift=-2pt]right) -- node[below] {$r$} ([yshift=-2pt]l);
    \draw[bracket] ([yshift=-5pt]r) -- node[below] {$l$} ([yshift=-5pt]left);
    \draw[bracket] ([yshift=-12pt]right) -- node[below] {$1$} ([yshift=-12pt]left);

    \begin{scope}[scale=0.82,shift={(0,-0.124)}]
        \hatshape[dotted]{1}{0}{\aa}{\bb}
        \draw[dotted] (midcenter) circle(\r);
    \end{scope}
}

% alpha, beta, incircle-area of right hat, rounding
\newcommand\hatsoverlap[4]{
    \pgfmathsetmacro{\a}{(#1)}
    \pgfmathsetmacro{\b}{(#2)}
    \pgfmathsetmacro{\x}{(#3)}
    \pgfmathsetmacro{\round}{(#4)}
    \pgfmathsetmacro{\f}{(1/(1+(1+cot(45-\b/2))^2/(1+cot(45-\a/2))^2))}

    \hatshape{1}{\round}{\a}{\b}
    \draw[dotted] (midcenter) circle(\r) node {$a$};
    \draw[bracket] ([yshift=-20pt]right) -- node[below] {$1$} ([yshift=-20pt]left);

    \pgfmathparse{sqrt(1/pi)/tan(\b/2)-sqrt(((\x))/pi)/tan(\b/2)}
    \begin{scope}[shift={(\pgfmathresult,0)}]
        \pgfmathparse{sqrt(1/pi)-sqrt(\x/pi)}
        \begin{scope}[shift={(0,-\pgfmathresult)}]
            \pgfmathsetmacro{\hata}{\x}
            \hatshape[dashed]{\hata}{0}{\a}{\b}
            \pgfmathsetmacro{\r}{sqrt(\x/pi)}
            \coordinate (r) at ($(midcenter)+(-\r,-\r)$);
            \draw (midcenter) circle(\r) node {$a_2$};
            \draw[bracket] ([yshift=-1pt]right) -- node[below] {$g$} ([yshift=-1pt]left);
            \draw[bracket] ([yshift=-12pt]right) -- node[below] {$rg$} ([yshift=-12pt]r);
        \end{scope}
    \end{scope}

    \def\comparg{\x}
    \if\comparg1\else
        \pgfmathparse{sqrt(1/pi)/tan(\a/2)-sqrt(((1-\x))/pi)/tan(\a/2)}
        \begin{scope}[shift={(-\pgfmathresult,0)}]
            \pgfmathparse{sqrt(1/pi)-sqrt((1-\x)/pi)}
            \begin{scope}[shift={(0,-\pgfmathresult)}]
                \pgfmathsetmacro{\hata}{1-\x}
                \hatshape[dashed]{\hata}{0}{\a}{\b}
                \pgfmathsetmacro{\r}{sqrt((1-\x)/pi)}
                \coordinate (l) at ($(midcenter)+(\r,-\r)$);
                \draw (midcenter) circle(\r) node {$a_1$};
                \draw[bracket] ([yshift=-4pt]right) -- node[below] {$f$} ([yshift=-4pt]left);
                \draw[bracket] ([yshift=-12pt]l) -- node[below] {$lf$} ([yshift=-12pt]left);
            \end{scope}
        \end{scope}
    \fi
}

% alpha, beta, incircle-area of right hat, rounding
\newcommand\hatpoke[4]{
    \pgfmathsetmacro{\a}{(#1)}
    \pgfmathsetmacro{\b}{(#2)}
    \pgfmathsetmacro{\x}{(#3)}
    \pgfmathsetmacro{\round}{(#4)}
    \pgfmathsetmacro{\f}{(1/(1+(1+cot(45-\b/2))^2/(1+cot(45-\a/2))^2))}

    \hatshape{1}{\round}{\a}{\b}

    \pgfmathparse{sqrt(1/pi)/tan(\b/2)-sqrt(((\x))/pi)/tan(\b/2)}
    \begin{scope}[shift={(\pgfmathresult,0)}]
        \pgfmathparse{sqrt(1/pi)-sqrt(\x/pi)}
        \begin{scope}[shift={(0,-\pgfmathresult)}]
            \pgfmathsetmacro{\hata}{\x}
            \pgfmathsetmacro{\hatb}{max(\round,\f*(\x/\f-(1-\x)/(1-\f)))}
            \hatshape[draw=none]{\hata}{\hatb}{90}{\b}
            \draw[dashed] (midcenter) circle(\r) node {$a_i$};
            \draw[dashed] (topcenter) circle(\s) node {$y$};
            \draw[bracket] ([shift={(11pt,11pt)}]top) -- node[sloped,above] {$d\sqrt{a_i}$} ([shift={(11pt,11pt)}]right);

            \begin{scope}[shift={(topcenter)}]
                \hatshape{\hatb}{0}{90}{\b}
                \draw[bracket] ([shift={(1pt,1pt)}]top) -- node[sloped,above] {$d\sqrt{y}$} ([shift={(1pt,1pt)}]right);
            \end{scope}

            \hatshape{\hata}{0}{90}{\b}
        \end{scope}
    \end{scope}

    \pgfmathparse{sqrt(1/pi)/tan(\b/2)-sqrt((\f)/pi)/tan(\b/2)}
    \begin{scope}[shift={(\pgfmathresult,0)}]
        \pgfmathparse{sqrt(1/pi)-sqrt((\f)/pi)}
        \begin{scope}[shift={(0,-\pgfmathresult)}]
            \hatshape{\f}{0}{90}{\b}
            \draw[dashed] (midcenter) circle(\r) node {$f_i$};
            \draw[bracket] ([shift={(6pt,6pt)}]top) -- node[sloped,above] {$d\sqrt{f_i}$} ([shift={(6pt,6pt)}]right);
        \end{scope}
    \end{scope}

    %\def\comparg{\x}
    %\if\comparg1\else
    %    \pgfmathparse{sqrt(1/pi)/tan(\a/2)-sqrt(((1-\x))/pi)/tan(\a/2)}
    %    \begin{scope}[shift={(-\pgfmathresult,0)}]
    %        \pgfmathparse{sqrt(1/pi)-sqrt((1-\x)/pi)}
    %        \begin{scope}[shift={(0,-\pgfmathresult)}]
    %            \pgfmathsetmacro{\hata}{1-\x}
    %            \hatshape[dashed]{\hata}{0}{\a}{\b}
    %            \pgfmathsetmacro{\r}{sqrt((1-\x)/pi)}
    %            \draw (midcenter) circle(\r) node {$a_1$};
    %        \end{scope}
    %    \end{scope}
    %\fi
}

\newcommand\squareworstcase{
    \draw (0,0) rectangle (\B,\B);
    \newcommand\circrad{0.398942}
    \draw[filled] (\circrad,\circrad) circle (\circrad) node {$\frac 1 2$};
    \draw[filled] (\B-\circrad,\B-\circrad) circle (\circrad) node {$\frac 1 2$};
}

\newcommand\squareworstcaseconstruction{
    \draw (0,0) rectangle (\B,\B);
    \newcommand\circrad{0.398942}
    \coordinate (c1) at (\circrad,\circrad);
    \coordinate (c2) at (\B-\circrad,\B-\circrad);
    \coordinate (c) at (\B/2,\B/2);
    \draw[dashed] (c1) circle (\circrad);
    \draw[dashed] (c2) circle (\circrad);
    \draw[tight] (c1) edge[above] node {$r$} +(180:\circrad) -- node[above left] {$r$} ++(45:\circrad) -- node[above left] {$r$} ++(45:\circrad) -- node[above] {$r$} ++(0:\circrad);
    \draw (c1) -- node[below] {$\frac{r}{\s}$} (c1 -| c) -- (c) -- (c2 |- c) -- (c2);
}

\newcommand\bigquestion{
    \draw (0,0) rectangle (\B,\B);
    \node at ({\B/2},{\B/2}) {$\approx 1.855$};
    \draw[->,thick] (-1,{\B/2}) -- node[above] {?} +(0.5,0);
    \draw[filled] (-3,{\B/2+0.3}) circle(0.3257); % 1/3
    \draw[filled] (-2.3,{\B/2+0.3}) circle(0.3257); % 1/3
    \draw[filled] (-1.7,{\B/2+0.3}) circle(0.2303); % 1/6
    \draw[filled] (-3,{\B/2-0.3}) circle(0.1629); % 1/12
    \draw[filled] (-2.6,{\B/2-0.3}) circle(0.1152); % 1/24
    \draw[filled] (-2.2,{\B/2-0.3}) circle(0.1152); % 1/24
    \draw[bracket] (-1.4697,0) -- node[below] {$1$} (-3.3257,0);
}

\newcommand\hatsimple{
    \hatshape{1}{0.2}{45}{30}

    \draw[dashed] (rightcenter) circle(\s) node {$b$};
    \draw[dashed] (leftcenter) circle(\s) node {$b$};
    \draw[dashed] (topcenter) circle(\s) node {$b$};
    \draw[dashed] (midcenter) circle(\r) node {$a$};
}

\newcommand\hatconstruction{
    \hatshape[draw=none]{1}{0.3}

    \draw[dashed] (rightcenter) circle(\s);
    \draw[dashed] (leftcenter) circle(\s);
    \draw[dashed] (midcenter) circle(\r);
    \draw[dashed] (right) -- (top) -- (left) -- cycle;

    \draw[tight] (rightcenter) -- node[below left] {$s$} ++(-45:\s) -- node[below right] {$s$} ++(45:\s) coordinate (rightright) {} -- node[right] {$s$} ++(-90:\s) -- node[above] {$s$} (right);
    \draw[thick,orange] (rightright) -- node[sloped,above] {$s\sqrt{2}$} (right);

    \draw[tight] (leftcenter) -- node[above] {$s$} ++(180:\s) -- node[left] {$s$} ++(-90:\s) coordinate (leftleft) {} -- node[below left] {$s$} ++(135:\s) -- node[below right] {$s$} (left);
    \draw[thick,orange] (leftleft) -- node[below] {$s\sqrt{2}$} (left);

    \draw[thick,left,blue] (0,0) -- node {$r$} (midcenter) -- node {$r\sqrt{2}$} (top);
    \draw (midcenter) -- node[below right] {$r$} +(45:\r) -- node[above right] {$r$} (top);
    \draw[thick,red] (left) -- node[sloped,above] {$(r+r\sqrt{2})\sqrt{2}$} (top);

    \coordinate (leftofleft) at ($(left)+(180:5pt)$);
    \coordinate (belowleft) at ($(left)-(90:5pt)$);
    \coordinate (farbelowleft) at ($(left)-(90:10pt)$);
    \coordinate (abovetop) at ($(top)+(45:5pt)$);
    \coordinate (farabovetop) at ($(top)+(45:10pt)$);
    \coordinate (faraboveright) at ($(right)+(45:10pt)$);
    \coordinate (aboverightright) at ($(rightright)+(45:5pt)$);
    \coordinate (leftend) at ($(leftleft)-(90:5pt)$);
    \coordinate (rightend) at ($(rightright)-(90:5pt)$);
    \coordinate (totheright) at ($(rightcenter)+(0:\s)$);
    \coordinate (rightend) at ($(totheright)-(90:5pt)$);

    \draw[bracket] (leftofleft) -- node[left] {$h(a)$} (leftofleft |- top);
    \draw[bracket] (rightend |- belowleft) -- node[below] {$w(a,b)$} (leftend |- belowleft);
    \draw[bracket] (rightend |- farbelowleft) -- node[below] {$w'(a,b)$} (left |- farbelowleft);
    \draw[bracket] (abovetop) -- node[above,sloped] {$d(a,b)$} (aboverightright);
    \draw[bracket] (farabovetop) -- node[above,sloped] {$d'(a)$} (faraboveright);
}
