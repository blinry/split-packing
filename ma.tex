%\documentclass[paper=a4,abstract=on,cleardoublepage=empty,numbers=noenddot,toc=bib,12pt,appendixprefix=true]{scrreprt}
\documentclass[%
    a4paper,              % DIN A4
    style=screen,          % print: enables twoside, print colors, and BCOR=15mm
    bibliography=totoc,   % bibliography gets unnumbered entry
    nexus,                % corporate design font
    lnum,                 % use "Versalziffern" instead of "Mediaevalziffern"
    extramargin,          % override corporate design margin to give more space for one-column text
]{tubsbook}

\input{header.tex}

\usepackage[english]{babel} % hyphenation

\hypersetup{
    colorlinks, linkcolor={medium-blue},
    citecolor={medium-blue}, urlcolor={medium-blue}
}

%\titlehead{
%    \begin{center}
%        \includegraphics[width=0.5\textwidth]{square_example.png}
%    \end{center}
%}

\subject{Master's Thesis}
\title{Algorithms\\for Circle Packing}
\author{\sffamily\LARGE Sebastian Morr}
\date{\large June 2, 2016}
\publishers{\textbf{Institute of Operating Systems and Computer Networks\\Prof.\,Dr.\,Sándor\,Fekete}\\
\vspace*{2em}
Supervisors:\\
Dr.\,Christian\,Scheffer\\
Jan-Marc\,Reinhardt,\,M.\,Sc.}

\begin{document}
\frontmatter % roman page numbering

\maketitle
\cleardoublepage

% statement of originality
\thispagestyle{plain} % no header
\vspace*{7cm}
\centerline{\bfseries Statement of Originality}
\vspace*{1em}
\noindent
This thesis has been performed independently with the support of my supervisors.
To the best of the author's knowledge, this thesis contains no material previously
published or written by another person except where due reference is made in the text.

\par
  \bigskip\noindent Braunschweig, June 2, 2016 \par
  \vspace*{10mm}
  \hfill\hrulefill
\cleardoublepage

% abstract
\thispagestyle{plain} % no header
\centerline{\bfseries Abstract}
\vspace*{1em}
\noindent
Very abstract indeed.
\cleardoublepage

% include Aufgabenstellung pdf
%\includepdf[pages=-]{aufgabenstellung/Aufgabenstellung}
%\cleardoublepage

\section*{Acknowledgments}

I would like to thank the following people for their support in the creation of this thesis:

\section*{Colophon}

This document was created using \LaTeXe\ by Leslie Lamport and contributors, and \KOMAScript\ by Frank Neukam, Markus Kohm, and Axel Kielhorn. The figures were created using PGFPlots by Christian Feuersänger and Ti\textit{k}Z by Till Tantau. The text is set in the Latin Modern font family by Bogusław Jackowski, Janusz M. Nowacki and Marcin Woliński, the monospaced font is \texttt{Bera Mono}, based on Bitstream Vera.

\cleardoublepage
\setcounter{tocdepth}{2}

\tableofcontents
\cleardoublepage

%\listoffigures
%\cleardoublepage
%
%\listoftables
%\cleardoublepage

\mainmatter % arabic numbering

\chapter{Introduction}

\begin{figure}[htbp!]
    \centering

    \begin{tikzpicture}[scale=2.5]
        \squareworstcase
    \end{tikzpicture}

    \caption{Worst-case instance for packing density?}
    \label{fig:worst-case}
\end{figure}

Consider the circle packing shown in \Cref{fig:worst-case}. For these two circles, the surrounding square is the smallest one in which the circles can be packed. Originally, we considered the following problem: Does this instance constitute the worst case in terms of packing density, or is there a set of circles with the same combined area that cannot be packed into this square? Put differently, can all other sets of circles with the same combined area as these two
(like the one in \Cref{fig:big-question})
be packed into this specific square?
We will give a constructive proof that this is indeed the case.

\begin{figure}[htbp!]
    \centering

    \begin{tikzpicture}[scale=2.5]
        \bigquestion
    \end{tikzpicture}

    \caption{Can these circles be packed?}
    \label{fig:big-question}
\end{figure}

\chapter{Preliminaries}

\section{Circle instances}

We start off with some definitions which make our life easier when talking about circles and circle instances:

\begin{definition}
    For each $0 \le a$, an \emph{$a$-circle} is a circle with an area of $a$.
\end{definition}

\begin{definition}
    A \emph{circle instance} is a multiset of non-negative real numbers, which define the circles' areas. Addition of circle instances is defined like on multisets.
\end{definition}

\begin{definition}
    For a circle instance $A$, $\mysum(A)$ is the combined area of the instance's circles.
\end{definition}

\begin{definition}
    $\C$ is the set of all circle instances. $\C(a)$ consist of exactly those circle instances with a combined area of at most $a$. Finally, $\C(a,b)$ consists of exactly those circle instances $A \in \C(a)$, for which each circle in $A$ has an area of at least $b$.
\end{definition}

\chapter{Common techniques}

\section{Greedy splitting}

The core idea of the proposed packing algorithms is to repeatedly split the set of input circles into groups. The method which performs this splitting resembles a greedy scheduling algorithm. It is going to be important for the packing algorithm that the ratio of the groups' sizes is close to certain factors.

The algorithm, \textsc{Split}, takes two parameters: The first is an arbitrary circle instance $C$. The second is a tuple of positive factors, which determines which percentages of $C$'s total area should go into the respective groups. For example, if we wanted to split $C$ into equally sized halves, we could choose the tuple $(1,1)$, and if we wanted to split $C$ into four groups with the proportions 1:1:1:3, we could use $(1,1,1,3)$. We call this tuple the \emph{split key}:

\begin{definition}
    A \emph{split key} is a tuple of at least two positive real numbers.
\end{definition}

Of course, it will not always be possible to achieve this desired ratio exactly (for example if the input instance consists of few very large---or even only one---circle), but we can derive some properties from the resulting subinstances if the resulting group's sizes derive from the split key.

In each step, \textsc{Split} adds the largest remaining circle of the input instance to the “emptiest” group---the group where the ratio between the current total sum and the associated factor of the split key is the smallest. The scenario which is easiest to imagine is when the split key actually describes the desired total area of that group, and \textsc{Split} puts the next circle into the group which has the smallest “filling level”.

\begin{algorithm}[htbp!]
    \caption{\textsc{Split}$(C,F)$}
    \begin{algorithmic}
        \Require A circle instance $C$ and a split key $F = (f_1, f_2, \dots, f_n)$
        \Ensure Circle instances $C_1, C_2, \dots, C_n$
        \For{$i = 1$ to $n$}
            \State $C_i \gets \emptyset$
        \EndFor
        \State Sort $C$ descending by size
        \ForAll{$c \in C$}
            \State $j = \min_{1 \le i \le n} \frac{\mysum(C_i)}{f_i}$\Comment{Find the index of the emptiest instance}
            \State $C_j \gets C_j \cup \{c\}$
        \EndFor
    \end{algorithmic}
\end{algorithm}

\begin{theorem}\label{th:split-property}
    For any circle instance $C$ and any split key $F = (f_1, f_2, \dots, f_n)$, \textsc{Split}$(C,F)$ decomposes $C$ into $n$ circle instances with $C_0 + C_1 + \dots + C_n = C$. 
    Call the instances' sums $a_1, a_2, \dots, a_n$, and define $r_i = \frac{a_i}{f_i}$ as the relative filling level of $C_i$.
    Set $r^* = \min\{r_0,r_1,\dots,r_n\}$.
    Then all $c \in C_i$ have a size of at least $f_i(r_i-r^*) = a_i - f_i r^*$.
\end{theorem}

\begin{proof}
    Assume for contradicion $C_i$ contained an element smaller than $f_i(r_i-r^*)$. All elements which were put into $C_i$ after that have to be at least as small, as the elements were sorted by descending size. So the last element put into $C_i$ (let us call it $c$) would be smaller than $f_i(r_i-r^*)$, as well.
    But this means that $\frac{\mysum(C_i) - c}{f_i} > \frac{\mysum(C_i) - f_i(r_i-r^*)}{f_i} = r_i - (r_i-r^*) = r^*$, meaning that at the moment before $c$ was inserted, the relative filling level of $C_i$ would already have been larger than $r^*$. But $r^*$ is the smallest relative filling level by the time the algorithm ends, so when $c$ is inserted, it would have been at least as small. But this is a contradiction to the algorithm's greedy nature, as \textsc{Split} would not have but $c$ into $C_i$ in this situation.
\end{proof}

\section{Shapes, Rounding, and Split Packing}

We will make some general observations about shapes which are suitable to pack certain classes of circle instances. Most of the proofs appearing in later chapters, while tailored to specific kinds of shapes (triangles, squares), will use these quite universal theorems.

\begin{definition}
    For any $\mathcal{C} \subseteq \C$, a $\mathcal{C}$-shape is a shape in which each $C \in \mathcal{C}$ can be packed.
\end{definition}

For example, if a shape is a $\C(a)$-shape, it means that each circle instance with a total area of $a$ can be packed into the shape. That's an interesting property that we will hunt after for most of this thesis, as it means no matter how the instances divide the area $a$ into circles, they can all be packed into the shape.

Recall that $\C(a,b)$ contains all circle instances with a total area of $a$ and a minimum circle size of $b$. If a shape is a $\C(a,b)$-shape with $b > 0$, it means that it can pack all circle instances consisting of circles of at least size $b$. This leads to an interesting effect: As the shape does not need to accomodate for circles smaller than $b$, it can be “rounded” to a radius of a $b$-circle. Sharper corners will be superfluous, as circles in $\C(a,b$) will not be permitted to be placed there anyway.
%In particular, this means that the shape's maximum local curvature can be the curvature of a $b$-circle, as when the curvature is 

\begin{definition}
    For a $\C(a,b)$-shape, we call $a$ the shape's \emph{sum} and $b$ the shape's \emph{rounding}.
\end{definition}

%\begin{theorem}
%    A shape is a $\mathcal{C}$-shape, if, for a given decomposition method, for all possible decompositions $C_1, C_2, \dots, C_n$ of any $C \in \mathcal{C}$, one can always find $n$ shapes in which the resulting subinstances can be packed, and which fit into the original shape.
%\end{theorem}

%Here is a definition that makes it easier to talk about 
The next definition looks a bit weird, but makes it easier to talk about multiple shapes:

\begin{definition}\label{def:tangled}
    For any split key $F$ of length $n$, we say that a tuple of $n$ shapes is \emph{$(F,b)$-rounded}, if the $i$-th shape is a $\C(a_i, \min\{b,a_i - f_i r^*\})$-shape, with $r^* = \max\{\frac{a_i}{f_i}|i \in 1,2,\dots,n\}$.
\end{definition}

What is means for shapes to be $(F,b)$-rounded is that we lift some requirements on which instances they need to be able to pack. We combine two lower bounds for the minimum size of the instances: First, the shapes never need to be able to pack any instances containing circles smaller than $b$. Second, they reflect the \textsc{Split}-algorithm's minimum element sizes stated in \Cref{th:split-property}. If a subinstance $C_i$ returned by \textsc{Split} can not possibly contain any circles smaller than a certain size, it makes sense to also relax the requirements for the shapes in which these subinstances will be packed: It suffices if they can pack those instances where the circles have this minimum size. Whichever of the two circle sizes requirements is largest, determines the “minimum size” of the rounded shape.

%Put differently, to have $F$-rounded shapes of the correct totals is a sufficient condition to be able to pack resulting subinstances of a \textsc{Split} operation into them. This is expressed in the following lemma:

%\begin{theorem}
%    A shape is a $\C(a,b)$-shape, if there is a split key $F$, so that for all $a_1 + a_2 + \dots + a_n \le a$, one can find a $\C(a_1)$-shape, a $\C(a_2)$-shape, \dots, and a $\C(a_n)$-shape, which are $F$-rounded and fit into the original shape.
%\end{theorem}

\begin{lemma}\label{th:split-tangle}
    Given an arbitrary $C \in \C(a,b)$ and a split key $F$, use \textsc{Split}$(C,F)$ to decompose $C$ into $n$ subinstances. Call the subinstances' totals $a_1$, $a_2$, \dots, $a_n$. If we can find $n$ $(F,b)$-rounded shapes where the $i$-th shape has a total of $a_i$, we can pack $C$ into the shapes.
\end{lemma}

\begin{proof}
    By \Cref{th:split-property}, \textsc{Split} only produces subinstance $C_i \in \C(a_i, (a_i, a_i-f_i r^*))$. Also, because each $C_i \subseteq C$, $C_i \in \C(a,b)$. So, $C_i \in \C(a_i, \min\{b,a_i - f_i r^*\})$, and as our shapes are $(F,b)$-rounded, \Cref{def:tangled} guarantees that the $i$-th subinstance can be packed into the $i$-th shape.
\end{proof}

With these preparations, we can now state our main theorem:

\begin{theorem}[Split Packing]\label{th:splitpack}
    For a given shape, and for any $0 \le b < a$, if there is a split key $F$ of length $n$, so that for all tuples $(a_1, a_2, \dots, a_n)$
    one can find $n$ $(F,b)$-rounded shapes where the $i$-th shape has a total of $a_i$, and these shapes can be packed into the original shape, then the original shape is a $\C(a,b)$-shape.
\end{theorem}

\begin{proof}
    Given an arbitrary $C \in \C(a,b)$, regardless of which groups \textsc{Split} produces, we know from \Cref{th:split-tangle} that we can always pack them into our $(F,b)$-rounded shapes. As these shapes also fit into the original shape, we know that we can pack $C$ into that shape.
\end{proof}

As this theorem is important for the whole thesis, let us rephrase it: \Cref{th:splitpack} encapsulates what is sufficient to proof that a shape is a $\C(a,b)$-shape: Find a shape-specific split key $F$ and show that for all possible decompositions of the area $a$ (which is going to be perfomed by \textsc{Split}), one can find $(F,b)$-rounded shapes of matching sums.

\begin{algorithm}[htbp!]
    \caption{\textsc{Splitpack}$(S,C)$}
    \begin{algorithmic}
        \Require A $\C(a,b)$-shape $S$ and a circle instance $C \in \C(a,b)$
        \Ensure A packing of $C$ into $S$
        \State Determine split key $F$ for $S$
        \State $(C_1, C_2, \dots, C_n) \gets \textsc{Split}(C,F)$
        \State $(S_1, S_2, \dots, S_n) \gets$ any $(F,b)$-rounded shapes of matching sums
        \State Pack these shapes into $S$
        \ForAll{$C_i \in (C_1, C_2, \dots, C_n)$}
            \State \Call{Splitpack}{$S_1, C_1$}
        \EndFor
    \end{algorithmic}
\end{algorithm}

One needs the following elements to use \textsc{Splitpack} for a shape:

\begin{enumerate}
    \item A strategy to determine the split factor $F$
    \item A strategy to determine $n$ $(F,b)$-rounded shapes of matching sums for each decomposition of the area $a$
    \item A strategy to pack these shapes into $S$
\end{enumerate}

To proof that the shape is indeed a $\C(a,b)$-shape, one needs to show that the first two strategies always exist, and that the third strategy always works.

\begin{itemize}
    \item One can always find $(F,b)$-rounded shapes which can be packed 
\end{itemize}

\section{Normalization}

In some proofs, we will normalize the instances, shapes, or figures in question. For example, we can scale all areas involved up by a factor of $f$, as long as we scale all lengths up by a factor of $\sqrt{f}$.

\chapter{Hats}

A useful family of shapes, which can be packed into each other quite well, are rounded triangles. We call these shapes \emph{hats}:

\begin{definition}
    For each $0 \le b \le a$, an \emph{$(a,b)$-hat} is a non-acute triangle with an incircle of area $a$, whose corners are rounded to the radius of a $b$-circle (see \Cref{fig:hat}).
    %An $a$-hat is an $(a,0)$-hat.
    %If we say \emph{obtuse hat}, \emph{right hat}, or \emph{acute hat}, the hat is based on an obtuse/right/acute triangle.
\end{definition}

\begin{figure}[htbp!]
    \centering

    \begin{tikzpicture}[scale=3]
        \hatsimple
    \end{tikzpicture}

    \caption{An $(a,b)$-hat.}
    \label{fig:hat}
\end{figure}

\begin{definition}
    A hat's \emph{associated split key} equals the areas of the two circles incribed in the hat's two sides when splitting it orthogonal to its base through its tip.
\end{definition}

%%For the following proofs, we need to know a hat's dimensions in detail. We construct these measures using \Cref{fig:construction}.
%%
%%\begin{lemma}\label{lm:sizes}
%%    Let $r$ be the radius of an $a$-circle, and $s$ be the radius of a $b$-circle.
%%
%%    A ($a,b$)-hat has
%%    \begin{itemize}
%%        \item height $h(a) = \textcolor{blue}{r + r\s} = \sqrt{\frac a \pi}(1+\s)$,
%%        \item width $w(a,b) = 2\textcolor{blue}{(r+r\s)} - 2\textcolor{orange}{s\s} = \sqrt{\frac a \pi}(2+2\s)-\sqrt{\frac b \pi}2\s$,
%%        \item and diagonal $d(a,b) = \textcolor{red}{(r+r\s)\s} - \textcolor{orange}{s\s} = \sqrt{\frac a \pi}(2+\s)-\sqrt{\frac b \pi}\s$.
%%    \end{itemize}
%%
%%    We define two additional measures for the case when one of the corners is not rounded:
%%    \begin{itemize}
%%        \item corner-width $w'(a,b) = w(a,b) + \textcolor{orange}{s\s} = \sqrt{\frac a \pi}(2+2\s)-\sqrt{\frac b \pi}\s$,
%%        \item and corner-diagonal $d'(a) = d(a,0) = \sqrt{\frac a \pi}(2+\s)$.
%%    \end{itemize}
%%\end{lemma}
%%
%%\begin{figure}[htbp!]
%%    \centering
%%
%%    \begin{tikzpicture}[scale=4]
%%        \hatconstruction
%%    \end{tikzpicture}
%%
%%    \caption{Constructing the dimensions of an $(a,b)$-hat.}
%%    \label{fig:construction}
%%\end{figure}
%%
\begin{figure}[htbp!]
    \centering

    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.1}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.2}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.3}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.4}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.5}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.6}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.7}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.8}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{0.9}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=1.3]
        \hatsinhat{45}{30}{1}{0}
    \end{tikzpicture}

    \caption{Hat-in-hat packings for different split ratios}
    \label{fig:hatsinhat}
\end{figure}

\begin{lemma}\label{th:hatsinhat}
    For each $(a,0)$-hat with the associated split key $F$,
    %for $$f = \frac{1}{1+\frac{1+\cot(\frac{\pi}{4}-\frac{\alpha}{2}))^2}{(1+\cot(\frac{\pi}{4}-\frac{\beta}{2}))^2}}$$,
    any two $F$-rounded right hats with an incircle sum of at most $a$ can be packed into the hat.
\end{lemma}

\begin{proof}
    Place the hats' tips at the bottom of the hat and push them as far to the left/right as possible, like in \Cref{fig:hatsinhat}.

    This placement constitutes a valid packing if (1) the hats do not overlap each other and (2) the hats fit into the hat individually.
    \begin{itemize}
        \item[(1)]
            We will first show that the hats do not overlap each other.

            To do so, we first normalize the container hat's width to 1 and make an observation about the partial widths $l$ and $r$ in \Cref{fig:hatlr}: If the top angle is a right angle, the partial widths have the same lengths as the triangle's two cathetus $x$ and $y$, so $l^2 + r^2 = 1$. If the top angle is obtuse, but the incircle's center stays at the same $x$-coordinate (like the dotted variant), both $l$ and $r$ shrink, so for each hat, $l^2 + r^2 \le 1$.

            \begin{figure}[htbp!]
                \centering

                \begin{tikzpicture}[scale=3]
                    \hatlr{60}{30}{51}{25}
                \end{tikzpicture}

                \caption{$l^2 + r^2 \le 1$ holds for each non-acute triangle}
                \label{fig:hatlr}
            \end{figure}

            We then observe that the hats to be packed don't overlap if their incircles don't overlap, which is true if in \Cref{fig:hatsoverlap}, $lf + rg \le 1$ holds. Also note that for \emph{similar} hats, the ratio between their incircle's area and the square of their widths is constant. This means that if $a_1 + a_2 = a$, $f^2 + g^2 = 1$.

            \begin{figure}[htbp!]
                \centering

                \begin{tikzpicture}[scale=3]
                    \hatsoverlap{45}{30}{0.7}{0}
                \end{tikzpicture}

                \caption{$f^2 + g^2 = 1$ for each non-acute triangle}
                \label{fig:hatsoverlap}
            \end{figure}

            Thus:

            \begin{align*}
                lf + rg
                &\le lf + \sqrt{1-l^2} \sqrt{1-f^2}\\
                &= lf + \sqrt{(1-l^2)(1-f^2)}\\
                &= lf + \sqrt{1 - f^2 - l^2 + l^2f^2}\\
                &\le lf + \sqrt{1 - 2lf + l^2f^2}\tag{\theequation}\label{eq:am-gm}\\
                &= lf + \sqrt{(1-lf)^2}\\
                &= 1
            \end{align*}

            Line \ref{eq:am-gm} is a consequence of the inequality of arithmetic and geometric means.

        \item[(2)]
            It is left to show that the hats fit inside the container individually.

            If a hat's area $a_i \le f_i$, its incircle is at most as big as the incircle of the container hat's side, so it will fit inside without question.

            \begin{figure}[htbp!]
                \centering

                \begin{tikzpicture}[scale=3]
                    \hatpoke{40}{50}{0.6}{0}
                \end{tikzpicture}

                \caption{}
                \label{fig:hatpoke}
            \end{figure}

            So let's assume $a_i > f_i$. For this proof, normalize $a$ to 1. The hat fits into the container hat individually if

            $$\sqrt{a} - (1-\sqrt{f})\sqrt{y} \le \sqrt{f}$$

            As the relative filling level of this hat is higher than that of the other one, this hat is rounded by $y = a - f\frac{1-a}{1-f}) = \frac{a(1-f)-f(1-a)}{1-f} = \frac{a-f}{1-f}$. $z = a-f$.

            $$\sqrt{f+z} - (1-\sqrt{f})\sqrt{\frac{z}{1-f}} \le \sqrt{f}$$

            Substitute $f = b^2$ and $z = c^2$.

            $$\sqrt{b^2+c^2} - (1-b)\frac{c}{\sqrt{1-b^2}} \le b$$

            Bring the subtrahend to the right and square both sides.

            $$b^2+c^2 \le b^2 + \frac{2b(1-b)c}{\sqrt{1-b^2}} + (1-b)^2\frac{c^2}{1-b^2}$$

            Subtract $b^2$, divide by $c$ and rearrange.

            $$c\frac{(1-b^2)-(1-b)^2}{\sqrt{1-b^2}} \le \frac{(1-b^2)-(1-b)^2}{\sqrt{1-b^2}}\sqrt{1-b^2}$$

            $$c \le \sqrt{1-b^2} \iff c^2 \le 1-b^2 \iff z \le 1-f$$
    \end{itemize}
\end{proof}

\begin{theorem}\label{th:roundedhatsinhat}
    For each $(a,b)$-hat with the associated split key $F$,
    %for $$f = \frac{1}{1+\frac{1+\cot(\frac{\pi}{4}-\frac{\alpha}{2}))^2}{(1+\cot(\frac{\pi}{4}-\frac{\beta}{2}))^2}}$$,
    for each $a_1 + a_2 = a$, there are two $F$-rounded right hats, where one is an $(a_1,b)$-hat and the other an $(a_2,b)$-hat, which can be packed into the hat.
\end{theorem}

\begin{proof}
    The container's corners are now rounded to the radius of a $b$-circle, and we need to show that the two hats from the previous construction still fit inside. But the all corners of the contained hats are also rounded to (at least) the same radius, so they will never overlap the container, see \Cref{fig:rounding-hats}.
\end{proof}

\begin{figure}[htbp!]
    \centering

    \begin{tikzpicture}[scale=2]
        \hatsinhat{45}{30}{0.8}{0}
    \end{tikzpicture}
    \begin{tikzpicture}[scale=2]
        \hatsinhat{45}{30}{0.8}{0.1}
    \end{tikzpicture}

    \caption{Rounding all hats' corners by the same radius does not affect the packing.}
    \label{fig:rounding-hats}
\end{figure}

\begin{theorem}
    An $(a,b)$-hat is a $\C(a,b)$-shape.
\end{theorem}

\begin{proof}
    Given a circle instance $C \in \C(a,b)$, if it only consists of a single circle, it cannot be larger than the incircle of the $(a,b)$-hat, so it can be packed.

    Otherwise, by \Cref{th:roundedhatsinhat} and \Cref{th:split-tangle}, it follows directly that the hat is a $\C(a,b)$-shape.
\end{proof}

\chapter{Triangles}

\begin{theorem}
    For any non-acute triangle with an incircle of area $a$, for any $b > a$ there are instances in $\C(b)$ which cannot be packed into the triangle.
\end{theorem}

\begin{proof}
    The instance $\{b\}$ cannot be packed, as the incircle is by definition the largest circle which fits into the triangle.
\end{proof}

\begin{theorem}
    A non-acute triangle with an incircle of area $a$ is an $\C(a)$-shape.
\end{theorem}

\begin{proof}
    The triangle is an $(a,0)$-hat, which is an $\C(a)$-shape.
\end{proof}

%\begin{theorem}
%    Each $A \in \C(a)$ can be packed into an isosceles triangle with a largest angle $\gamma$ between $\frac{\pi}{2}$ and $\frac{\pi}{3}$ and an area of $a\frac{1+\frac{1}{\sin(\gamma)}}{\pi}$.
%\end{theorem}
%
%\begin{theorem}
%    For any $0 < x$ and $0 < y$, there are always 
%    a $(x+z)$-hat and a
%    Each $A \in \C(a)$ can be packed into an obtuse triangle with an incircle of area $a$.
%\end{theorem}
%
%\chapter{Squares}
%
%\begin{figure}[htbp!]
%    \centering
%
%    \begin{tikzpicture}[scale=2]
%        \hatsinsquare{0.5}
%    \end{tikzpicture}
%    \begin{tikzpicture}[scale=2]
%        \hatsinsquare{0.49}
%    \end{tikzpicture}
%    \begin{tikzpicture}[scale=2]
%        \hatsinsquare{0.4}
%    \end{tikzpicture}
%    \begin{tikzpicture}[scale=2]
%        \hatsinsquare{0.2}
%    \end{tikzpicture}
%    \begin{tikzpicture}[scale=2]
%        \hatsinsquare{0}
%    \end{tikzpicture}
%
%    \caption{Hat-in-square packings for different values of $\frac{x}{x+y}$}
%    \label{fig:hatsinsquare}
%\end{figure}
%
%
%
%Finally, we can bring the \textsc{Split} algorithm and the properties of the hat shapes together and give constructive proofs for the existence of circle packings:

%\begin{proof}
%Call the hat's smaller angles $\alpha$ and $\beta$. Set $f = $
%\end{proof}
%
%We are now ready to prove our main theorem:
%

\chapter{Squares}

\begin{lemma}
    If the circle instance shown in \Cref{fig:b} has a combined area of $a$, the square has an area of $\frac{3+2\s}{\pi}a \approx 1.85525a$. Call this worst-case factor $\Psi$.
\end{lemma}

\begin{proof}
    Note that because a circle of radius $r$ has an area of $a = \pi r^2$, an $a$-circle has a radius of $r = \sqrt{\frac a \pi}$. Then, by construction as seen in \Cref{fig:b}:

    $$\Psi a = \left(2r + 2\frac{r}{\s}\right)^2 = r^2\left(2+\s\right)^2 = \frac{\frac a 2}{\pi}\left(4+4\s+2\right) = \frac{3+2\s}{\pi}a$$
\end{proof}

\begin{figure}[htbp!]
    \centering

    \begin{tikzpicture}[scale=3]
        \squareworstcaseconstruction
    \end{tikzpicture}

    \caption{Constructing $\Psi$.}
    \label{fig:b}
\end{figure}

Our problem can now be expressed like this: Can all circle instances $A \in \C(a)$ be packed into a square with an area of $\Psi a$? This will be \Cref{th:circlesinsquare}, and the rest of this paper will build up to its proof.


\begin{theorem}\label{th:circlesinsquare}
    A square with an area of $\frac{3+2\s}{\pi} a$ is a $\C(a)$-shape.
\end{theorem}

%\begin{theorem}\label{th:hatsinsquare}
%    For any $0 \le x \le y$, an $x$-hat and a $(y,y-x)$-hat can always be packed into a square with an area of $\Psi(x+y)$.
%\end{theorem}
%
%\begin{proof}
%    Place the tips of the hats in two opposing corners of the square, like in \Cref{fig:hatsinsquare}.
%    This placement constitues a valid packing if (1) the hats fit into the square individually and (2) the hats do not overlap.
%
%    \begin{itemize}
%        \item[(1)]
%            The hats fit into the square individually if their diagonal never gets larger than the square's edge length $\sqrt{\Psi(x+y)} = \frac{1+\s}{\sqrt{\pi}}\sqrt{x+y}$.
%            As $x \le \frac {x+y} 2$, \Cref{lm:sizes} directly tells us that the $x$-hat has a diagonal of at most
%            \begin{align*}
%                d(x,0) \le d(\frac{x+y}{2},0) = \sqrt{\frac{\frac{x+y}{2}}{\pi}}(2+\s) + 0 = \sqrt{\Psi(x+y)}
%            \end{align*}
%
%            As for the $(y,y-x)$-hat, its diagonal is also never larger than $\sqrt{\Psi(x+y)}$: \todo[inline]{algebraic proof TBD :-)}
%
%            \begin{tikzpicture}
%                \begin{axis}[height=5cm,xtick={0,0.5},xlabel=$\frac{x}{x+y}$,domain=0:0.5,legend pos=outer north east,no markers,samples=500]
%                    \addplot[red,thick] {sqrt((1-x)/pi)*(2+sqrt(2))-sqrt((1-2*x)/pi)*sqrt(2)};
%                    \addplot[blue,thick] {(1+sqrt(2))/sqrt(pi)};
%                    \legend{$\frac{d{(y,y-x)}}{\sqrt{x+y}}$,$\sqrt{\Psi}$}
%                \end{axis} 
%            \end{tikzpicture}
%
%            %\begin{align*}
%            %    d(y,y-x)
%            %    &= \sqrt{\frac{y}{\pi}}(2+\s)-\sqrt{\frac{y-x}{\pi}}\s\\
%            %    &\le \sqrt{\frac{\frac{x+y}{2}}{\pi}}(2+\s)-\sqrt{\frac{y-y}{\pi}}\s\\
%            %    &= \frac{1+\s}{\sqrt{\pi}}\sqrt{x+y} = \sqrt{\Psi(x+y)}
%            %\end{align*}
%
%        \item[(2)]
%            The hats don't overlap if their combined height never exceeds $\sqrt{2\Psi(x+y)}$, the square's diagonal:
%            \begin{align*}
%                h(x) + h(y)
%                &= \sqrt{\frac{x}{\pi}}(1+\s) + \sqrt{\frac{y}{\pi}}(1+\s)\\
%                &= \frac{1+\s}{\sqrt\pi}(\sqrt{x}+\sqrt{y})\\
%                &\le \frac{1+\s}{\sqrt\pi}(\sqrt{2x+2y})\\
%                &= \s\frac{1+\s}{\sqrt\pi}\sqrt{x+y} = \sqrt{2\Psi(x+y)} \qedhere
%            \end{align*}
%    \end{itemize}
%\end{proof}

%\begin{proof}
%    If $A$ only consists of a single $a$-circle, it can be placed at the center of the square, as its diameter of $2\sqrt{\frac{a}{\pi}} \approx 1.12838\sqrt{a}$ is smaller than the squares edge length $\sqrt{\Psi a} \approx 1.36207\sqrt{a}$. Otherwise, by \Cref{th:split-property}, \textsc{Split} decomposes $A$ into $X \in \C(x)$ and $Y \in \C(y,y-x)$. By \Cref{th:circlesinhat}, we can pack $X$ into a $x$-hat and $Y$ into a $(y,y-x)$-hat. By \Cref{th:hatsinsquare}, we can pack those two hats into the square.
%
%    See \Cref{fig:example} for a complete example packing.
%\end{proof}
%
%\begin{figure}[htbp!]
%    \centering
%    \includegraphics[width=0.5\textwidth]{square_example.png}
%    \caption{Packing of an example instance.}
%    \label{fig:example}
%\end{figure}

\chapter{Conclusions and Future Work}

\appendix

\end{document}
